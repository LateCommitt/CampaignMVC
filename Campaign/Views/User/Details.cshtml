@model EntityLayer.Concrete.User
@{
    ViewData["Title"] = "Kullanıcı Detayları";
    var metrics = ViewBag.Metrics as EntityLayer.Concrete.UserMetrics;
    var assignments = ViewBag.Assignments as List<EntityLayer.Concrete.CampaignAssignment>;
}

<div class="container">
    <h1>Kullanıcı Detayları</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Kullanıcı Bilgileri</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">ID:</dt>
                        <dd class="col-sm-8">@Model.Id</dd>

                        <dt class="col-sm-4">Ad:</dt>
                        <dd class="col-sm-8">@Model.Name</dd>

                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">@Model.Email</dd>

                        <dt class="col-sm-4">Şehir:</dt>
                        <dd class="col-sm-8">@Model.City</dd>

                        <dt class="col-sm-4">Segment:</dt>
                        <dd class="col-sm-8">@Model.Segment</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Kullanıcı Metrikleri</h5>
                </div>
                <div class="card-body">
                    @if (metrics != null)
                    {
                        <dl class="row">
                            <dt class="col-sm-6">Aylık Veri (GB):</dt>
                            <dd class="col-sm-6">@metrics.MonthlyDataGb</dd>

                            <dt class="col-sm-6">Aylık Harcama (TL):</dt>
                            <dd class="col-sm-6">@metrics.MonthlySpendTry</dd>

                            <dt class="col-sm-6">Sadakat Yılı:</dt>
                            <dd class="col-sm-6">@metrics.LoyaltyYears</dd>
                        </dl>
                    }
                    else
                    {
                        <p>Kullanıcı metrikleri bulunmamaktadır.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Kampanya Atamaları</h5>
            <button type="button" id="processScoreBtn" class="btn btn-primary btn-sm" onclick="processUserScore(@Model.Id)">
                <span id="processScoreText">Skor Hesapla ve Kampanya Ata</span>
                <span id="processScoreSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
        </div>
        <div class="card-body">
            @if (assignments != null && assignments.Any())
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Kampanya ID</th>
                            <th>Skor</th>
                            <th>Durum</th>
                            <th>Atama Tarihi</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var assignment in assignments)
                        {
                            <tr>
                                <td>@assignment.CampaignId</td>
                                <td>@assignment.Score</td>
                                <td>@assignment.Status</td>
                                <td>@assignment.AssignedAt.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>Bu kullanıcı için kampanya ataması bulunmamaktadır.</p>
            }
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">Geri Dön</a>
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Düzenle</a>
        <a asp-action="UserRecommendations" asp-route-id="@Model.Id" class="btn btn-success">Skor Hesapla & Kampanya Önerileri</a>
    </div>
</div>

<div id="scoreResult" class="alert d-none mt-3"></div>

@section Scripts {
    <script>
        function processUserScore(userId) {
            const btn = document.getElementById('processScoreBtn');
            const text = document.getElementById('processScoreText');
            const spinner = document.getElementById('processScoreSpinner');
            const resultDiv = document.getElementById('scoreResult');
            
            // Processing durumunu göster
            btn.disabled = true;
            text.textContent = 'İşleniyor...';
            spinner.classList.remove('d-none');
            resultDiv.classList.add('d-none');
            
            // AJAX çağrısı
            fetch('/User/ProcessUserScore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ userId: userId })
            })
            .then(response => response.json())
            .then(data => {
                // Başarılı
                if (data.success) {
                    resultDiv.className = 'alert alert-success mt-3';
                    resultDiv.innerHTML = `
                        <h5>✓ İşlem Tamamlandı!</h5>
                        <p>${data.message}</p>
                        <hr>
                        <p><strong>Toplam Skor:</strong> ${data.score} / 100</p>
                        <p><strong>Kullanım Skoru:</strong> ${data.usageScore}</p>
                        <p><strong>Harcama Skoru:</strong> ${data.spendScore}</p>
                        <p><strong>Sadakat Skoru:</strong> ${data.loyaltyScore}</p>
                        <p class="mb-0"><small>Sayfa 2 saniye içinde yenilenecek...</small></p>
                    `;
                    resultDiv.classList.remove('d-none');
                    
                    // 2 saniye sonra sayfayı yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Hata
                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.innerHTML = `<strong>Hata:</strong> ${data.message}`;
                    resultDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.innerHTML = `<strong>Hata:</strong> ${error.message}`;
                resultDiv.classList.remove('d-none');
            })
            .finally(() => {
                // Butonu tekrar aktif et
                btn.disabled = false;
                text.textContent = 'Skor Hesapla ve Kampanya Ata';
                spinner.classList.add('d-none');
            });
        }
    </script>
}
